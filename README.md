# 🛍️ Корпоративный Telegram Магазин

**Многофункциональный Telegram бот для корпоративного магазина с системой T-Points и HR управлением**

![Python](https://img.shields.io/badge/Python-3.12-blue)
![aiogram](https://img.shields.io/badge/aiogram-3.20.0-green)
![SQLAlchemy](https://img.shields.io/badge/SQLAlchemy-2.0.41-orange)
![License](https://img.shields.io/badge/License-Private-red)

## 📋 Описание

Корпоративный Telegram бот для внутреннего магазина компании с системой виртуальной валюты T-Points, каталогом товаров, управлением заказами и HR функциями.

### 🎯 Основные возможности

- **👥 Система пользователей**: Онбординг, профили, роли (пользователь/HR/админ)
- **🛒 Каталог товаров**: Категории, товары с размерами, цветами, остатками
- **🛍️ Корзина и заказы**: Добавление в корзину, оформление, отслеживание статусов
- **💎 T-Points система**: Виртуальная валюта, транзакции, активности
- **📦 HR управление**: Управление заказами, пользователями, отчетность
- **🎂 Автоуведомления**: Дни рождения, юбилеи, остатки товаров
- **❓ Q&A система**: Анонимные вопросы и ответы
- **📊 Аналитика**: Отчеты по заказам, активности, T-Points
- **🔧 Сетевая устойчивость**: Автоматические повторы, обработка ошибок Telegram API

## 🏗️ Архитектура

Проект построен по принципам **Clean Architecture**:

```
🎯 Handlers (UI слой)
    ↓ используют
🔧 Services (Бизнес-логика)
    ↓ используют  
💾 Repositories (Слой данных)
    ↓ работают с
🗃️ Models (SQLAlchemy модели)
```

### 🔧 Middleware

- **DatabaseMiddleware**: Управление сессиями БД, DI контейнер, очередь уведомлений
- **GroupMembershipMiddleware**: Проверка членства в группе
- **HROrAdminAccess**: Контроль доступа для HR/Admin функций

### 📦 Ключевые компоненты

- **aiogram3-di**: Dependency Injection
- **SQLAlchemy 2.0**: Асинхронная работа с БД
- **aiosqlite**: SQLite для разработки/тестирования
- **APScheduler**: Планировщик автоматических событий
- **SafeTelegramClient**: Безопасная отправка сообщений с retry логикой

## 🚀 Установка и запуск

### Требования

- Python 3.12+
- SQLite (для разработки) или PostgreSQL (для продакшена)

### 1. Клонирование и установка

```bash
git clone <repository-url>
cd PRODACTION
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows
pip install -r requirements.txt
```

### 2. Конфигурация

Создайте файл `.env`:

```env
BOT_TOKEN=your_telegram_bot_token
GROUP_ID=your_telegram_group_id
DATABASE_URL=sqlite+aiosqlite:///data/shop.db
DEBUG=false

# Настройки сети и Telegram API
TELEGRAM_TIMEOUT=30
TELEGRAM_RETRY_COUNT=3
TELEGRAM_RETRY_DELAY=1.0
AIOHTTP_POOL_SIZE=100
AIOHTTP_TIMEOUT=60
```

### 3. Инициализация БД

```bash
# Создание структуры БД
python -c "
import asyncio
from app.database import create_tables
asyncio.run(create_tables())
"

# Запуск миграций
python migrations/create_auto_events_system.py
python migrations/create_notification_types_system.py
python migrations/create_tpoints_activities.py
```

### 4. Запуск бота

```bash
python main.py
```

## 🗂️ Структура проекта

```
PRODACTION/
├── app/                        # Основной код приложения
│   ├── catalog/               # Модуль каталога товаров
│   │   ├── handlers/         # Обработчики каталога
│   │   ├── keyboards/        # Клавиатуры каталога
│   │   └── utils/           # Утилиты каталога
│   ├── orders/               # Модуль заказов
│   │   ├── keyboards/       # Клавиатуры заказов
│   │   ├── analytics.py     # Аналитика заказов
│   │   ├── management.py    # HR управление заказами
│   │   ├── user_orders.py   # Пользовательские заказы
│   │   └── notifications.py # Обработчики уведомлений о заказах
│   ├── handlers/            # Основные обработчики
│   │   ├── main_menu.py     # Главное меню и онбординг
│   │   ├── simple_admin.py  # Админ панель и настройки
│   │   ├── questions.py     # Q&A система для пользователей
│   │   ├── hr_questions.py  # HR управление вопросами
│   │   ├── user_management.py # Управление пользователями
│   │   ├── events_management.py # Ручная проверка событий
│   │   ├── auto_events_handlers.py # Обработчики автособытий
│   │   └── tpoints_activity.py # Управление T-Points активностями
│   ├── services/            # Бизнес-логика
│   │   ├── notifications/   # Система уведомлений
│   │   │   ├── base_notification_service.py # Базовый сервис
│   │   │   ├── order_notifications.py # Уведомления о заказах
│   │   │   ├── user_notifications.py # Уведомления пользователям
│   │   │   └── question_notifications.py # Уведомления о вопросах
│   │   ├── user.py         # Управление пользователями
│   │   ├── order.py        # Управление заказами
│   │   ├── cart.py         # Корзина покупок
│   │   ├── catalog.py      # Управление каталогом
│   │   ├── question.py     # Q&A система
│   │   ├── status_service.py # Управление статусами
│   │   ├── onboarding_service.py # Онбординг новых пользователей
│   │   ├── user_manager_service.py # Продвинутое управление пользователями
│   │   ├── transaction_service.py # T-Points транзакции
│   │   ├── refund_service.py # Возвраты и отмены
│   │   ├── excel_service.py # Импорт/экспорт Excel
│   │   ├── group_management_service.py # Управление группой
│   │   ├── tpoints_activity_service.py # T-Points активности
│   │   └── auto_events_service.py # Автоматические события
│   ├── repositories/        # Слой данных
│   │   ├── user_repository.py # Работа с пользователями в БД
│   │   ├── order_repository.py # Работа с заказами в БД
│   │   ├── catalog_repository.py # Работа с каталогом в БД
│   │   ├── cart_repository.py # Работа с корзинами в БД
│   │   ├── billing_repository.py # T-Points операции в БД
│   │   ├── question_repository.py # Работа с вопросами в БД
│   │   ├── status_repository.py # Работа со статусами в БД
│   │   ├── auto_events_repository.py # Автособытия в БД
│   │   └── tpoints_activity_repository.py # T-Points активности в БД
│   ├── middlewares/         # Промежуточное ПО
│   │   ├── database.py     # БД и DI
│   │   ├── access_control.py # Контроль доступа
│   │   └── group_membership.py # Проверка группы
│   ├── models/             # SQLAlchemy модели
│   │   └── models.py       # Все модели БД
│   ├── keyboards/          # Общие клавиатуры
│   ├── utils/              # Утилиты
│   │   ├── telegram_client.py # Безопасный Telegram клиент
│   │   ├── callback_helpers.py # Помощники для callback
│   │   ├── message_editor.py # Редактирование сообщений
│   │   └── temp_file_manager.py # Управление временными файлами
│   ├── constants/          # Константы
│   │   └── departments.py  # Отделы компании
│   ├── core/               # Основные компоненты
│   │   ├── base.py        # Базовые классы
│   │   ├── constants.py   # Системные константы
│   │   └── di.py          # Dependency Injection
│   ├── filters/            # Фильтры aiogram
│   │   ├── chat_type.py   # Фильтр типа чата
│   │   └── role.py        # Фильтр роли пользователя
│   ├── config.py           # Конфигурация
│   ├── database.py         # Настройка БД
│   └── scheduler.py        # Планировщик событий
├── data/                   # База данных
├── logs/                   # Логи приложения
├── migrations/             # Миграции БД
├── tests/                  # Тесты
├── main.py                # Точка входа
└── requirements.txt       # Зависимости
```

## 📚 Подробное описание модулей

### 🎯 Handlers (Обработчики)

#### main_menu.py
- Главное меню бота
- Онбординг новых пользователей
- Обработка команды `/start`
- Навигация по основным разделам

#### simple_admin.py
- Админ панель для HR и администраторов
- Настройки автоматических событий
- Персональные настройки уведомлений
- Системные настройки

#### user_management.py
- Импорт пользователей из Excel
- Экспорт данных пользователей
- Ручное управление T-Points
- Управление ролями

#### questions.py / hr_questions.py
- Анонимная Q&A система
- Пользователи задают вопросы
- HR отвечают на вопросы
- Система уведомлений

#### events_management.py
- Ручная проверка событий HR
- Просмотр предстоящих дней рождения
- Проверка юбилеев
- Контроль остатков товаров

#### tpoints_activity.py
- Управление T-Points активностями
- Создание/редактирование активностей
- Импорт из Excel
- Начисление T-Points за активности

### 🔧 Services (Сервисы)

#### Система уведомлений
- **BaseNotificationService**: Базовый класс с SafeTelegramClient
- **OrderNotificationService**: Уведомления о заказах (создание, статусы, отмена)
- **UserNotificationService**: Уведомления пользователям (дни рождения, юбилеи)
- **QuestionNotificationService**: Уведомления о вопросах и ответах

#### Основные сервисы
- **UserService**: Управление пользователями
- **OrderService**: Логика заказов с возвратами
- **CartService**: Корзина покупок
- **CatalogService**: Управление каталогом товаров
- **StatusService**: Управление статусами заказов

#### Специализированные сервисы
- **OnboardingService**: Процесс регистрации новых пользователей
- **UserManagerService**: Продвинутое управление пользователями
- **TransactionService**: T-Points транзакции
- **RefundService**: Возвраты и отмены заказов
- **ExcelService**: Импорт/экспорт Excel файлов
- **GroupManagementService**: Управление Telegram группой
- **TPointsActivityService**: Управление активностями
- **AutoEventsService**: Автоматические события (ДР, юбилеи, остатки)

### 💾 Repositories (Репозитории)

Все репозитории наследуются от BaseRepository и предоставляют асинхронные методы для работы с БД:

- **UserRepository**: CRUD операции с пользователями
- **OrderRepository**: Операции с заказами и аналитика
- **CatalogRepository**: Управление товарами и категориями
- **CartRepository**: Операции с корзинами
- **BillingRepository**: T-Points транзакции
- **QuestionRepository**: Q&A система
- **StatusRepository**: Статусы заказов
- **AutoEventsRepository**: Настройки автособытий
- **TPointsActivityRepository**: T-Points активности

### 🛠️ Utils (Утилиты)

#### SafeTelegramClient
Продвинутый клиент для работы с Telegram API:
- Автоматические повторы при сетевых ошибках
- Обработка rate limiting
- Batch отправка сообщений
- Безопасное редактирование сообщений

#### Другие утилиты
- **CallbackHelpers**: Безопасная обработка callback запросов
- **MessageEditor**: Редактирование сообщений с обработкой ошибок
- **TempFileManager**: Управление временными файлами

## 👥 Роли пользователей

### 🙋‍♂️ Пользователь (user)
- Просмотр каталога товаров
- Добавление в корзину и заказы
- Просмотр баланса T-Points и истории
- Отправка анонимных вопросов
- Отмена собственных заказов

### 👩‍💼 HR (hr)
- Все возможности пользователя
- Управление заказами (принятие, статусы, выдача)
- Управление пользователями (импорт, экспорт, T-Points)
- Ответы на вопросы
- Аналитика и отчеты
- Управление каталогом товаров
- Персональные настройки уведомлений

### 👨‍💻 Администратор (admin)
- Все возможности HR
- Настройка автоматических уведомлений
- Системные настройки
- Доступ ко всей аналитике
- Управление ролями пользователей

## 💎 T-Points система

### Начисление T-Points
- **Дни рождения**: Настраиваемая сумма
- **Юбилеи работы**: Базовая сумма + множитель за годы
- **Активности**: Через систему TPointsActivity
- **Ручное начисление**: HR/Админ

### Списание T-Points
- **Покупки**: Автоматически при оформлении заказа
- **Возвраты**: При отмене заказов
- **Ручное списание**: HR/Админ

### Безопасность транзакций
- Все операции с T-Points атомарны
- Защита от двойного списания/начисления
- Полная история всех операций
- Откат транзакций при ошибках

## 🎂 Автоматические события

### Настройки
- **Дни уведомлений**: за сколько дней присылать напоминания
- **Время отправки**: когда отправлять уведомления
- **T-Points**: сколько начислять
- **Персональные настройки**: каждый HR может включить/выключить типы уведомлений

### Типы событий
1. **Дни рождения** 🎂
   - Уведомления HR за X дней до ДР
   - Автоматическое начисление T-Points в день ДР
   - Поздравления от имени компании

2. **Юбилеи работы** 🏆
   - Отслеживание годовщин трудоустройства
   - Прогрессивное начисление T-Points (базовая сумма + годы стажа)
   - Персонализированные поздравления

3. **Остатки товаров** 📦
   - Мониторинг остатков товаров
   - Уведомления при достижении минимального порога
   - Только для HR и администраторов

## 📊 Аналитика ⚠️ **В РАЗРАБОТКЕ**

> **ВНИМАНИЕ**: Модуль аналитики (`app/orders/analytics.py`) требует доработки. Основная функциональность работает через Excel экспорт.

### Работающий экспорт данных
- ✅ Пользователи в Excel
- ✅ T-Points транзакции в Excel  
- ✅ Настройка активностей через Excel
- ✅ Отчеты по заказам

### Планируемая функциональность (после исправления):
- **Заказы**: статистика по периодам, статусам, отделам
- **Товары**: популярные товары, остатки
- **T-Points**: обороты, топ пользователей
- **Пользователи**: активность, регистрации

## 🛡️ Сетевая устойчивость

### SafeTelegramClient
- **Автоматические повторы**: до 3 попыток при сетевых ошибках
- **Экспоненциальная задержка**: увеличение времени ожидания между попытками
- **Rate limiting**: автоматическая обработка ограничений Telegram
- **Batch операции**: групповая отправка сообщений с ограничением параллелизма

### Обработка ошибок
- **TelegramNetworkError**: автоматические повторы
- **TelegramServerError**: обработка ошибок сервера Telegram
- **TelegramRetryAfter**: соблюдение лимитов API
- **TelegramBadRequest**: корректная обработка неверных запросов

### Конфигурация сети
```env
TELEGRAM_TIMEOUT=30          # Таймаут запросов к Telegram API
TELEGRAM_RETRY_COUNT=3       # Количество повторных попыток
TELEGRAM_RETRY_DELAY=1.0     # Задержка между попытками
AIOHTTP_POOL_SIZE=100        # Размер пула соединений
AIOHTTP_TIMEOUT=60           # Таймаут aiohttp клиента
```

## 🔧 API и интеграции

### Команды бота
- `/start` - Регистрация/главное меню
- `/admin` - Админ панель (только для админов)

### Callback обработчики
- Навигация по каталогу
- Управление корзиной
- Статусы заказов
- Админ панель
- Q&A система

## 🛡️ Безопасность

### Контроль доступа
- Middleware для проверки ролей
- Фильтрация по группе Telegram
- Валидация всех пользовательских данных

### Данные
- Шифрование чувствительных данных
- Логирование всех операций
- Защита от SQL инъекций через SQLAlchemy

## 📈 Масштабирование

### Готовность к продакшену
- Поддержка PostgreSQL
- Асинхронная архитектура
- Очередь уведомлений
- Логирование и мониторинг

### Нагрузка
- Рассчитано на ~100 одновременных пользователей
- Connection pooling для БД
- Оптимизированные запросы
- Безопасная отправка уведомлений

## 🔄 Миграции

### Доступные миграции
```bash
# Система автоматических событий
python migrations/create_auto_events_system.py

# Система типов уведомлений
python migrations/create_notification_types_system.py

# T-Points активности
python migrations/create_tpoints_activities.py
```

## 📝 Логирование

### Уровни логов
- **INFO**: Основные операции
- **WARNING**: Предупреждения
- **ERROR**: Ошибки
- **DEBUG**: Отладочная информация

### Файлы логов
- `logs/bot.log` - Все логи приложения

## 🧪 Тестирование

```bash
# Запуск тестов
pytest tests/

# Создание тестового пользователя
python create_test_user.py
```

## 🤝 Разработка

### Добавление новых функций

1. **Создайте модель** в `app/models/models.py`
2. **Создайте репозиторий** в `app/repositories/`
3. **Создайте сервис** в `app/services/`
4. **Создайте обработчики** в `app/handlers/`
5. **Добавьте клавиатуры** в `app/keyboards/`
6. **Зарегистрируйте роутер** в `main.py`

### Стиль кода
- Используйте type hints
- Следуйте принципам Clean Architecture
- Документируйте публичные методы
- Покрывайте тестами новый функционал

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи в `logs/bot.log`
2. Убедитесь в правильности конфигурации `.env`
3. Проверьте статус БД и миграций
4. Обратитесь к документации aiogram

## 📄 Лицензия

Проект предназначен для внутреннего использования компании.

---

**Разработано с ❤️ для корпоративной экосистемы** 